#!/bin/bash -l

#SBATCH --time=3:00:00
#SBATCH --partition=shared
#SBATCH --nodes=1
#SBATCH --cpus-per-task=12
#SBATCH --ntasks-per-node=1


##i is read1 fq
datadir=~/work/ngs/170928_fungus76
prefix=`basename $1 _R1.fastq.gz`

ml samtools
ml bcftools

mkdir -p $datadir/align/$prefix
mkdir -p $datadir/cons/$prefix


##align for all genes
for i in $datadir/Reference/ref_alleles/*fasta ; 
do
    gene=`basename $i .fasta`
    bowtie2 -p 12 -x $datadir/Reference/ref_alleles/$gene -1 $1 -2 $datadir/fastqs/${prefix}_R2.fastq.gz | samtools view -bS | samtools sort -o $datadir/align/$prefix/$prefix.$gene.sorted.bam
    samtools index $datadir/align/$prefix/$prefix.$gene.sorted.bam

    samtools mpileup -uf $i $datadir/align/$prefix/$prefix.$gene.sorted.bam | bcftools call -c - | vcfutils.pl vcf2fq > $datadir/cons/$prefix/$prefix.$gene.cons.fq
    seqtk seq -a $datadir/cons/$prefix/$prefix.$gene.cons.fq > $datadir/cons/$prefix/$prefix.$gene.fasta
done
    
